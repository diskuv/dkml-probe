<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>C_conf (dkml-c-probe.Dkml_c_probe.C_conf)</title><link rel="stylesheet" href="../../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 2.1.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">dkml-c-probe</a> &#x00BB; <a href="../index.html">Dkml_c_probe</a> &#x00BB; C_conf</nav><header class="odoc-preamble"><h1>Module <code><span>Dkml_c_probe.C_conf</span></code></h1><p>Cross-compiler friendly configuration of C headers and libraries.</p></header><nav class="odoc-toc"><ul><li><a href="#problem">Problem</a></li><li><a href="#solution">Solution</a></li><li><a href="#prerequisites">Prerequisites</a></li><li><a href="#integrations">Integrations</a></li><li><a href="#module-documentation">Module Documentation</a></li></ul></nav><div class="odoc-content"><h2 id="problem"><a href="#problem" class="anchor"></a>Problem</h2><p>Let's take the C library &quot;gmp&quot; (GNU Multiprecision Bignum Library) as an example. Many OCaml libraries depend on it through the &quot;conf-gmp&quot; Opam package. However almost all &quot;conf-*&quot; packages use the system's package manager to install the C library or use &quot;pkg-config&quot; to locate the C library. So if the system were a Linux x86_64 system and the cross-compiling toolchain is for Android ARM64, the Android ARM64 executables should never be linked to the system Linux x86_64 C library &quot;gmp&quot;.</p><h2 id="solution"><a href="#solution" class="anchor"></a>Solution</h2><p>A solution is to let the consumer define and link to pre-existing cross-compiled libraries.</p><p>During cross-compilation each distinct toolchain would need its own external C libraries and perhaps C headers. This module lets the developer specify the locations of these libraries and headers by setting environment variables.</p><p>The environment variables follow the grammar:</p><pre>    variableName:
      'CP_' clibrary '_' type '_DEFAULT' ('_' toolchain)?
      ;
    clibrary:
      [A-ZA-Z0-9_]+
      ;
    toolchain:
      [A-ZA-Z0-9_]+
      ;
    type:
      'CP' | 'LINK'
      ;

    (*  Semicolons separate list items in a variable *)
    variableValue:
      listItem (';' listItem)*
      ;
    (*  Any 7-bit ASCII printable character are valid. Spaces are significant,
        and there are no space characters. *)
    listItem:
      ([\x20-\x7E] - ';')*
      ;</pre><p>Both <code>&quot;&lt;clibrary&gt;&quot;</code> and <code>&quot;&lt;toolchain&gt;&quot;</code> must be uppercased and sanitized with underscores.</p><p>For example, the following environment variables can be set for the C library &quot;gmp&quot;:</p><pre>    CP_GMP_CC_DEFAULT                 = -IZ:/build/darwin_arm64/vcpkg_installed/arm64-osx/include
    CP_GMP_CC_DEFAULT_DARWIN_X86_64   = -IZ:/build/darwin_x86_64/vcpkg_installed/x64-osx/include
    CP_GMP_LINK_DEFAULT               = -LZ:/build/darwin_arm64/vcpkg_installed/arm64-osx/lib;-lgmp
    CP_GMP_LINK_DEFAULT_DARWIN_X86_64 = -LZ:/build/darwin_x86_64/vcpkg_installed/x64-osx/lib;-lgmp</pre><p>Semantically each environment variable is equivalent to an optional list of items. In particular:</p><ul><li>An undefined environment variable and an empty environment variable are equivalent to an absent list (ie. <code>None</code>)</li><li>Any empty list item is skipped. So you can use <code>&quot;;&quot;</code> to mean <code>Some []</code></li></ul><p>For CC type variables, each list item is a command line option:</p><ul><li><code>&quot;-I&lt;path&gt;&quot;</code> adds an include directory. The path should have forward slashes, even on Windows.</li></ul><p>For LINK type variables, each list item is a command line option:</p><ul><li><code>&quot;-L&lt;path&gt;&quot;</code> adds a library directory. The path should have forward slashes, even on Windows.</li><li><code>&quot;-l&lt;library&gt;&quot;</code> adds a named library.</li></ul><p>There are no spaces between the command line option (ex. <code>&quot;-L&quot;</code>) and the option value.</p><p>As a library author you can use this module to convert these CC and LINK variables into the paricular convention used by your OCaml tool or C compiler. For example, using the <a href="#val-compiler_flags_msvc"><code>compiler_flags_msvc</code></a> in the <code>&quot;darwin_x86_64&quot;</code> toolchain will give you:</p><pre><code>let link_flags = [&quot;-LIBPATH:Z:/build/darwin_x86_64/vcpkg_installed/x64-osx/lib&quot;; &quot;gmp.lib&quot;]
let cc_flags = [&quot;-IZ:/build/darwin_x86_64/vcpkg_installed/x64-osx/include&quot;]</code></pre><p>while using the <a href="#val-tool_flags_ocamlmklib"><code>tool_flags_ocamlmklib</code></a> in the same toolchain will give you:</p><pre><code>let link_flags = [&quot;-LZ:/build/darwin_x86_64/vcpkg_installed/x64-osx/lib&quot;; &quot;-lgmp&quot;]</code></pre><h2 id="prerequisites"><a href="#prerequisites" class="anchor"></a>Prerequisites</h2><p>The consumer of your library will need:</p><ul><li>cross-compiled toolchains named according to <a href="../C_abi/index.html"><code>C_abi</code></a>'s <code>&quot;get_abi_name&quot;</code>.</li><li><p>pre-existing cross-compiled libraries. The cross-compiled libraries are available from many sources:</p><ul><li>development environments like Android Studio</li><li>C package managers like vcpkg and Conan</li><li>&quot;sysroot&quot; images</li><li>direct downloads from architecture specific package repositories</li></ul></li><li>set environment variables that reference the pre-existing cross-compiled libraries. For an Opam switch you can use <a href="https://opam.ocaml.org/doc/man/opam-option.html">opam option setenv+=&quot;CP_xxx=yyy&quot;</a>; the docs for setenv are at https://opam.ocaml.org/doc/Manual.html#opamfield-setenv</li></ul><h2 id="integrations"><a href="#integrations" class="anchor"></a>Integrations</h2><p>When you are using the <a href="https://dune.readthedocs.io/en/stable/dune-libs.html">Dune Configurator</a> you should:</p><ol><li>Use the <a href="#val-load_from_dune_context_name"><code>load_from_dune_context_name</code></a> constructor by supplying the Dune variable <code>&quot;%{context_name}&quot;</code></li><li>Use <a href="#val-compiler_flags_of_ccomp_type"><code>compiler_flags_of_ccomp_type</code></a> to get the compiler flags by supplying the Dune variable <code>&quot;%{ocaml-config:ccomp_type}&quot;</code>.</li></ol><p>Dune variables are described in the <a href="https://dune.readthedocs.io/en/stable/concepts.html#variables-1">General Concepts of the Dune Docs</a>.</p><h2 id="module-documentation"><a href="#module-documentation" class="anchor"></a>Module Documentation</h2><div class="odoc-spec"><div class="spec type" id="type-t" class="anchored"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> t</span></code></div></div><div class="odoc-spec"><div class="spec type" id="type-env_getter" class="anchored"><a href="#type-env_getter" class="anchor"></a><code><span><span class="keyword">type</span> env_getter</span><span> = <span>string <span class="arrow">&#45;&gt;</span></span> <span>string option</span></span></code></div></div><div class="odoc-spec"><div class="spec module" id="module-C_flags" class="anchored"><a href="#module-C_flags" class="anchor"></a><code><span><span class="keyword">module</span> <a href="C_flags/index.html">C_flags</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>Flags for C compilers</p></div></div><div class="odoc-spec"><div class="spec module" id="module-Ocamlmklib_flags" class="anchored"><a href="#module-Ocamlmklib_flags" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Ocamlmklib_flags/index.html">Ocamlmklib_flags</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>Flags for ocamlmklib</p></div></div><div class="odoc-spec"><div class="spec value" id="val-load" class="anchored"><a href="#val-load" class="anchor"></a><code><span><span class="keyword">val</span> load : <span>?getenv:<a href="#type-env_getter">env_getter</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="arrow">&#45;&gt;</span></span> <span><span>( <a href="#type-t">t</a>, string )</span> <span class="xref-unresolved">Stdlib</span>.result</span></span></code></div><div class="spec-doc"><p><code>load ?getenv ()</code> creates C configuration from the current <a href="../C_abi/index.html"><code>C_abi</code></a>.</p><p>If there is an error getting the C configuration then the result it <code>Error &quot;some error message&quot;</code>.</p><p>Otherwise, the result is the C configuration <code>conf</code>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-load_from_dune_context_name" class="anchored"><a href="#val-load_from_dune_context_name" class="anchor"></a><code><span><span class="keyword">val</span> load_from_dune_context_name : 
  <span>?getenv:<a href="#type-env_getter">env_getter</a> <span class="arrow">&#45;&gt;</span></span>
  <span>string <span class="arrow">&#45;&gt;</span></span>
  <span><span>( <a href="#type-t">t</a>, string )</span> <span class="xref-unresolved">Stdlib</span>.result</span></span></code></div><div class="spec-doc"><p><code>load_from_dune_context_name ?getenv ctxname</code> creates C configuration from the Dune variable <code>&quot;%{context_name}&quot;</code> that has been captured in <code>ctxname</code>.</p><p>Examples of <code>&quot;%{context_name}&quot;</code> are:</p><ul><li><code>&quot;default&quot;</code></li><li><code>&quot;default.darwin_arm64&quot;</code></li></ul></div></div><div class="odoc-spec"><div class="spec value" id="val-load_from_findlib_toolchain" class="anchored"><a href="#val-load_from_findlib_toolchain" class="anchor"></a><code><span><span class="keyword">val</span> load_from_findlib_toolchain : 
  <span>?getenv:<a href="#type-env_getter">env_getter</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>string option</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>( <a href="#type-t">t</a>, string )</span> <span class="xref-unresolved">Stdlib</span>.result</span></span></code></div><div class="spec-doc"><p><code>load_from_findlib_toolchain ?getenv toolchain_opt</code> creates C configuration from the optional findlib toolchain <code>toolchain_opt</code>.</p><p>Examples of <code>toolchain</code> are:</p><ul><li><code>None</code></li><li><code>Some &quot;darwin_arm64&quot;</code></li></ul></div></div><div class="odoc-spec"><div class="spec value" id="val-compiler_flags_of_ccomp_type" class="anchored"><a href="#val-compiler_flags_of_ccomp_type" class="anchor"></a><code><span><span class="keyword">val</span> compiler_flags_of_ccomp_type : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span>ccomp_type:string <span class="arrow">&#45;&gt;</span></span>
  <span>clibrary:string <span class="arrow">&#45;&gt;</span></span>
  <span><span>( <span><a href="C_flags/index.html#type-t">C_flags.t</a> option</span>, string )</span> <span class="xref-unresolved">Stdlib</span>.result</span></span></code></div><div class="spec-doc"><p><code>compiler_flags_of_ccomp_type conf ~ccomp_type ~clibrary</code> gets the compiler flags of the compiler identified by <code>&quot;ocamlc -config&quot;</code>'s <code>ccomp_type</code> from the C configuration <code>conf</code>.</p><p>If there is no C configuration for <code>clibrary</code>, the result is <code>Ok None</code>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-compiler_flags_msvc" class="anchored"><a href="#val-compiler_flags_msvc" class="anchor"></a><code><span><span class="keyword">val</span> compiler_flags_msvc : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span>clibrary:string <span class="arrow">&#45;&gt;</span></span>
  <span><span>( <span><a href="C_flags/index.html#type-t">C_flags.t</a> option</span>, string )</span> <span class="xref-unresolved">Stdlib</span>.result</span></span></code></div><div class="spec-doc"><p><code>compiler_flags_msvc conf ~clibrary</code> gets the compiler flags for the MSVC compiler from the C configuration <code>conf</code>.</p><p>If there is no C configuration for <code>clibrary</code>, the result is <code>Ok None</code>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-compiler_flags_gcc" class="anchored"><a href="#val-compiler_flags_gcc" class="anchor"></a><code><span><span class="keyword">val</span> compiler_flags_gcc : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span>clibrary:string <span class="arrow">&#45;&gt;</span></span>
  <span><span>( <span><a href="C_flags/index.html#type-t">C_flags.t</a> option</span>, string )</span> <span class="xref-unresolved">Stdlib</span>.result</span></span></code></div><div class="spec-doc"><p><code>compiler_flags_gcc conf ~clibrary</code> gets the compiler flags for the GCC compiler from the C configuration <code>conf</code>.</p><p>If there is no C configuration for <code>clibrary</code>, the result is <code>Ok None</code>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-tool_flags_ocamlmklib" class="anchored"><a href="#val-tool_flags_ocamlmklib" class="anchor"></a><code><span><span class="keyword">val</span> tool_flags_ocamlmklib : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span>clibrary:string <span class="arrow">&#45;&gt;</span></span>
  <span><span>( <span><a href="Ocamlmklib_flags/index.html#type-t">Ocamlmklib_flags.t</a> option</span>, string )</span> <span class="xref-unresolved">Stdlib</span>.result</span></span></code></div><div class="spec-doc"><p><code>tool_flags_ocamlmklib conf ~clibrary</code> gets the ocamlmklib flags from the C configuration <code>conf</code>.</p><p>If there is no C configuration for <code>clibrary</code>, the result is <code>Ok None</code>.</p></div></div></div></body></html>